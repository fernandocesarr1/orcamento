<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gr치ficos - Controle Or칞ament치rio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body>
    <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                Or칞amento Familiar
            </h1>
            <nav class="flex gap-2">
                <a href="adicionar.html" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 font-semibold text-sm">Adicionar</a>
                <a href="dashboard.html" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 font-semibold text-sm">Dashboard</a>
                <a href="graficos.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold text-sm">Gr치ficos</a>
                <a href="historico.html" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 font-semibold text-sm">Hist칩rico</a>
                <a href="pesquisa.html" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 font-semibold text-sm">Pesquisa</a>
                <a href="config.html" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 font-semibold text-sm">Config</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div id="graficos-content"></div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAgopSuSjeQ26UL85eYb11w4BbbNtBg5QE",
            authDomain: "orcamento-familiar-dc2e6.firebaseapp.com",
            databaseURL: "https://orcamento-familiar-dc2e6-default-rtdb.firebaseio.com",
            projectId: "orcamento-familiar-dc2e6",
            storageBucket: "orcamento-familiar-dc2e6.firebasestorage.app",
            messagingSenderId: "21809188621",
            appId: "1:21809188621:web:103d45c3353106ebf5aa44",
            measurementId: "G-4E95DZRK3F"
        };

        let database, appData = {}, gastos = [], charts = {};
        let selectedYear = new Date().getFullYear();
        let selectedMonth = new Date().getMonth();
        
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();

        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }

        function loadData() {
            database.ref('appData').once('value', (snapshot) => {
                appData = snapshot.val() || {
                    categorias: { fixas: ['Escola', 'Diarista', 'Internet', '츼gua', 'Luz', 'Clube'], variaveis: ['Supermercado', 'Farm치cia', 'Lazer'] },
                    nomes: ['Fernando', 'Estefania']
                };
            });

            database.ref('gastos').once('value', (snapshot) => {
                const data = snapshot.val();
                gastos = data ? Object.values(data) : [];
                renderGraficos();
            });
        }

        function getAnosDisponiveis() {
            const anos = new Set(gastos.map(g => new Date(g.data + 'T00:00:00').getFullYear()));
            if (anos.size === 0) anos.add(new Date().getFullYear());
            return Array.from(anos).sort((a, b) => b - a);
        }

        function processarDadosMensais(ano) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const dados = {
                labels: meses,
                total: Array(12).fill(0),
                pessoa1: Array(12).fill(0),
                pessoa2: Array(12).fill(0)
            };
            
            gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano) {
                    const mes = dataGasto.getMonth();
                    dados.total[mes] += gasto.valor;
                    if (gasto.responsavel === appData.nomes[0]) {
                        dados.pessoa1[mes] += gasto.valor;
                    } else if (gasto.responsavel === appData.nomes[1]) {
                        dados.pessoa2[mes] += gasto.valor;
                    }
                }
            });
            return dados;
        }

        function processarDadosPorMes(mes, ano) {
            const todasCategorias = [...appData.categorias.fixas, ...appData.categorias.variaveis].sort();
            const dados = {};
            
            todasCategorias.forEach(cat => { dados[cat] = 0; });
            
            gastos.forEach(gasto => {
                const dataGasto = new Date(gasto.data + 'T00:00:00');
                if (dataGasto.getFullYear() === ano && dataGasto.getMonth() === mes) {
                    if (dados[gasto.categoria] !== undefined) {
                        dados[gasto.categoria] += gasto.valor;
                    }
                }
            });
            
            return {
                labels: todasCategorias,
                valores: todasCategorias.map(cat => dados[cat])
            };
        }

        function criarGraficoMensal() {
            const dados = processarDadosMensais(selectedYear);
            const canvas = document.getElementById('graficoMensal');
            if (!canvas) return;
            
            if (charts.mensal) charts.mensal.destroy();
            
            const ctx = canvas.getContext('2d');
            charts.mensal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dados.labels,
                    datasets: [
                        { label: 'Total Geral', data: dados.total, borderColor: '#3b82f6', borderWidth: 3, tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                        { label: appData.nomes[0], data: dados.pessoa1, borderColor: '#f97316', borderWidth: 2, tension: 0.4, borderDash: [5, 5] },
                        { label: appData.nomes[1], data: dados.pessoa2, borderColor: '#8b5cf6', borderWidth: 2, tension: 0.4, borderDash: [5, 5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function criarGraficoCategoria() {
            const dados = processarDadosPorMes(selectedMonth, selectedYear);
            const meses = ['Janeiro', 'Fevereiro', 'Mar칞o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const canvas = document.getElementById('graficoCategoria');
            if (!canvas) return;
            
            if (charts.categoria) charts.categoria.destroy();
            
            const ctx = canvas.getContext('2d');
            charts.categoria = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dados.labels,
                    datasets: [{
                        label: `Gastos em ${meses[selectedMonth]} de ${selectedYear}`,
                        data: dados.valores,
                        backgroundColor: [
                            '#3b82f6', '#8b5cf6', '#f97316', '#10b981', '#ef4444',
                            '#f59e0b', '#06b6d4', '#ec4899', '#6366f1', '#84cc16',
                            '#14b8a6', '#f43f5e', '#a855f7', '#eab308', '#22c55e'
                        ],
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: function(value) { return 'R$ ' + value.toFixed(2); } }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: function(context) { return context.label + ': R$ ' + context.parsed.y.toFixed(2); } }
                        }
                    }
                }
            });
        }

        function renderGraficos() {
            const anos = getAnosDisponiveis();
            const meses = ['Janeiro', 'Fevereiro', 'Mar칞o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            if (gastos.length === 0) {
                document.getElementById('graficos-content').innerHTML = `
                    <div class="bg-white rounded-xl shadow p-8 text-center max-w-lg mx-auto">
                        <div class="text-6xl mb-4">游늵</div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Sem Dados para An치lise</h2>
                        <p class="text-slate-600">Adicione alguns gastos para come칞ar a ver os gr치ficos e insights sobre suas finan칞as.</p>
                    </div>
                `;
                return;
            }

            document.getElementById('graficos-content').innerHTML = `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow p-4 flex items-center gap-4">
                        <label class="text-sm font-semibold text-slate-700">Analisando o ano de:</label>
                        <select id="year-select" onchange="updateYear(this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500">
                            ${anos.map(ano => `<option value="${ano}" ${ano === selectedYear ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">游늳 Evolu칞칚o Mensal de Gastos (${selectedYear})</h2>
                        <div class="h-80"><canvas id="graficoMensal"></canvas></div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <h2 class="text-xl font-bold text-slate-800">游늵 Gastos por Categoria</h2>
                            <select id="month-select" onchange="updateMonth(this.value)" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-emerald-500">
                                ${meses.map((mes, idx) => `<option value="${idx}" ${idx === selectedMonth ? 'selected' : ''}>${mes} ${selectedYear}</option>`).join('')}
                            </select>
                        </div>
                        <div class="h-80"><canvas id="graficoCategoria"></canvas></div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                criarGraficoMensal();
                criarGraficoCategoria();
            }, 100);
        }

        function updateYear(ano) {
            selectedYear = parseInt(ano);
            renderGraficos();
        }

        function updateMonth(mes) {
            selectedMonth = parseInt(mes);
            renderGraficos();
        }

        loadData();
    </script>
</body>
</html>